

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using Chapel with InfiniBand &mdash; Chapel Documentation 1.24</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/style.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using Chapel with libfabric" href="libfabric.html" />
    <link rel="prev" title="Using Chapel on Amazon Web Services" href="aws.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

<a href="../index.html" class="icon icon-home"> Chapel Documentation

<!-- display version if button won't be rendered -->
<?php if (false) { ?>
<br>1.24
<?php } ?>

</a>

<?php
// Variables given by sphinx
$chplTitle = "1.24";
$pagename = "platforms/infiniband";
include "..//versionButton.php";
?>


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Compiling and Running Chapel</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/QUICKSTART.html">Quickstart Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/index.html">Using Chapel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Platform-Specific Notes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#major-platforms">Major Platforms</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#networks">Networks</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Using Chapel with InfiniBand</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#avoiding-slow-job-launch">Avoiding Slow Job Launch</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-slurm-for-job-launch">Using Slurm for Job Launch</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-ssh-for-job-launch">Using SSH for Job Launch</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-mpi-for-job-launch">Using MPI for Job Launch</a></li>
<li class="toctree-l4"><a class="reference internal" href="#see-also">See Also</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="libfabric.html">Using Chapel with libfabric</a></li>
<li class="toctree-l3"><a class="reference internal" href="omnipath.html">Using Chapel with OmniPath</a></li>
<li class="toctree-l3"><a class="reference internal" href="udp.html">Using the Portable UDP Conduit</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#older-platforms">Older Platforms</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../technotes/index.html">Technical Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Chapel Programs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language/reference.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Hello World Variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primers/index.html">Primers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/spec/index.html">Language Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../builtins/index.html">Built-in Types and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/standard.html">Standard Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/packages.html">Package Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/layoutdist.html">Standard Layouts and Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mason-packages.html">Mason Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users-guide/index.html">Chapel Users Guide (WIP)</a></li>
</ul>
<p class="caption"><span class="caption-text">Language History</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language/evolution.html">Chapel Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/archivedSpecs.html">Documentation Archives</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Chapel Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Platform-Specific Notes</a> &raquo;</li>
        
      <li>Using Chapel with InfiniBand</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/platforms/infiniband.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-chapel-with-infiniband">
<span id="readme-infiniband"></span><h1>Using Chapel with InfiniBand<a class="headerlink" href="#using-chapel-with-infiniband" title="Permalink to this headline">¶</a></h1>
<p>This document describes how to run Chapel across multiple machines in an
InfiniBand cluster.  <a class="reference internal" href="../usingchapel/multilocale.html#readme-multilocale"><span class="std std-ref">Multilocale Chapel Execution</span></a> describes general
information about running Chapel in a multilocale configuration.</p>
<div class="section" id="avoiding-slow-job-launch">
<h2>Avoiding Slow Job Launch<a class="headerlink" href="#avoiding-slow-job-launch" title="Permalink to this headline">¶</a></h2>
<p>We’ve observed very slow job launch on some systems with InfiniBand
that were resolved by limiting the memory available for
communication, for example with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">GASNET_PHYSMEM_MAX</span><span class="o">=</span>1G
</pre></div>
</div>
<p>Note that setting <code class="docutils literal notranslate"><span class="pre">GASNET_PHYSMEM_MAX</span></code> will limit amount of memory
available to Chapel programs if <code class="docutils literal notranslate"><span class="pre">CHPL_GASNET_SEGMENT=fast</span></code>.</p>
<p>It might be necessary to also set <code class="docutils literal notranslate"><span class="pre">GASNET_PHYSMEM_NOPROBE=1</span></code> -
especially if you increase the size of <code class="docutils literal notranslate"><span class="pre">GASNET_PHYSMEM_MAX</span></code>.</p>
<p>It’s probably a good idea to start with this variable set
and to try removing it once everything else is working.</p>
</div>
<div class="section" id="using-slurm-for-job-launch">
<h2>Using Slurm for Job Launch<a class="headerlink" href="#using-slurm-for-job-launch" title="Permalink to this headline">¶</a></h2>
<p>For clusters using Slurm, there are a few options:</p>
<ol class="loweralpha">
<li><p>The current best option for InfiniBand+Slurm is
<code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER=slurm-gasnetrun_ibv</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>gasnet
<span class="nb">export</span> <span class="nv">CHPL_COMM_SUBSTRATE</span><span class="o">=</span>ibv

<span class="nb">export</span> <span class="nv">CHPL_LAUNCHER</span><span class="o">=</span>slurm-gasnetrun_ibv

<span class="c1"># Rebuild the Chapel runtime for these settings</span>
<span class="nb">cd</span> <span class="nv">$CHPL_HOME</span>
make

<span class="c1"># Compile a sample program</span>
chpl -o hello6-taskpar-dist examples/hello6-taskpar-dist.chpl
</pre></div>
</div>
<p>See <a class="reference internal" href="../usingchapel/launcher.html#using-slurm"><span class="std std-ref">Using Slurm</span></a> for other options available, such
as setting the time limit or selecting the type of node.
Some settings might be required by your Slurm configuration.
Setting these variables are typically necessary:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify the Slurm partition to use</span>
<span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_PARTITION</span><span class="o">=</span>debug

<span class="c1"># Run the sample program</span>
./hello6-taskpar-dist -nl <span class="m">2</span>
</pre></div>
</div>
</li>
<li><p>An alternative is to use an ssh spawner and configure it to use the
nodes allocated by Slurm.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>gasnet
<span class="nb">export</span> <span class="nv">CHPL_COMM_SUBSTRATE</span><span class="o">=</span>ibv

<span class="nb">export</span> <span class="nv">CHPL_LAUNCHER</span><span class="o">=</span>gasnetrun_ibv

<span class="c1"># Rebuild the Chapel runtime for these settings</span>
<span class="nb">cd</span> <span class="nv">$CHPL_HOME</span>
make

<span class="c1"># Compile a sample program</span>
chpl -o hello6-taskpar-dist examples/hello6-taskpar-dist.chpl
</pre></div>
</div>
<p>Now, to run a program, reserve some nodes with <cite>salloc</cite> and then
within the resulting shell, configure the servers to SSH and run
the program:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reserve 2 nodes for an interactive run</span>
salloc -N <span class="m">2</span>
<span class="c1"># Then, within the salloc shell</span>

  <span class="c1"># Specify that ssh should be used</span>
  <span class="nb">export</span> <span class="nv">GASNET_IBV_SPAWNER</span><span class="o">=</span>ssh
  <span class="c1"># Run the program on the 2 reserved nodes.</span>
  <span class="c1"># gasnetrun_ibv will use the nodes Slurm allocated above.</span>
  ./hello6-taskpar-dist -nl <span class="m">2</span>
</pre></div>
</div>
<p>This technique is also possible when using <cite>sbatch</cite>. In that case,
make sure your <cite>sbatch</cite> script includes the line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">GASNET_IBV_SPAWNER</span><span class="o">=</span>ssh
</pre></div>
</div>
<p>See <a class="reference internal" href="../usingchapel/launcher.html#ssh-launchers-with-slurm"><span class="std std-ref">Using any SSH-based launcher with Slurm</span></a> for more information on these
techniques.</p>
</li>
<li><p>A further alternative is to configure GASNet to use <em>mpirun</em> to launch your
program. <em>mpirun</em> might already be configured to work with Slurm. See
<a class="reference internal" href="#using-mpi-for-job-launch">using-mpi-for-job-launch</a>.</p></li>
</ol>
</div>
<div class="section" id="using-ssh-for-job-launch">
<h2>Using SSH for Job Launch<a class="headerlink" href="#using-ssh-for-job-launch" title="Permalink to this headline">¶</a></h2>
<p>To launch InfiniBand jobs with SSH, use the following</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>gasnet
<span class="nb">export</span> <span class="nv">CHPL_COMM_SUBSTRATE</span><span class="o">=</span>ibv

<span class="nb">export</span> <span class="nv">CHPL_LAUNCHER</span><span class="o">=</span>gasnetrun_ibv

<span class="c1"># Rebuild the Chapel runtime for these settings</span>
<span class="nb">cd</span> <span class="nv">$CHPL_HOME</span>
make

<span class="c1"># Compile a sample program</span>
chpl -o hello6-taskpar-dist examples/hello6-taskpar-dist.chpl

<span class="c1"># Specify that ssh should be used</span>
<span class="nb">export</span> <span class="nv">GASNET_IBV_SPAWNER</span><span class="o">=</span>ssh
<span class="c1"># Specify the nodes to run on</span>
<span class="nb">export</span> <span class="nv">GASNET_SSH_SERVERS</span><span class="o">=</span><span class="s2">&quot;host1 host2 host3 ...&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-mpi-for-job-launch">
<span id="id1"></span><h2>Using MPI for Job Launch<a class="headerlink" href="#using-mpi-for-job-launch" title="Permalink to this headline">¶</a></h2>
<p>To launch InfiniBand jobs with <em>mpirun</em>, first make sure that <em>mpicc</em> is
available and that MPI programs launch appropriately with <em>mpirun</em>. Then use
the following. You’ll want to make sure that GASNet detects MPI in its
configuration output.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>gasnet
<span class="nb">export</span> <span class="nv">CHPL_COMM_SUBSTRATE</span><span class="o">=</span>ibv

<span class="nb">export</span> <span class="nv">CHPL_LAUNCHER</span><span class="o">=</span>gasnetrun_ibv

<span class="c1"># Rebuild the Chapel runtime for these settings</span>
<span class="nb">cd</span> <span class="nv">$CHPL_HOME</span>
make

<span class="c1"># Compile a sample program</span>
chpl -o hello6-taskpar-dist examples/hello6-taskpar-dist.chpl

<span class="c1"># Specify that ssh should be used</span>
<span class="nb">export</span> <span class="nv">GASNET_IBV_SPAWNER</span><span class="o">=</span>mpi
</pre></div>
</div>
</div>
<div class="section" id="see-also">
<h2>See Also<a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h2>
<p>For more information on these and other available GASNet options,
including configuring to launch through MPI, please refer to
GASNet’s official <a class="reference external" href="https://gasnet.lbl.gov/dist/ibv-conduit/README">InfiniBand conduit documentation</a>, which can also be found
in <code class="docutils literal notranslate"><span class="pre">$CHPL_HOME/third-party/gasnet/gasnet-src/ibv-conduit/README</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="libfabric.html" class="btn btn-neutral float-right" title="Using Chapel with libfabric" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="aws.html" class="btn btn-neutral float-left" title="Using Chapel on Amazon Web Services" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Hewlett Packard Enterprise Development LP

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 



</body>
</html>