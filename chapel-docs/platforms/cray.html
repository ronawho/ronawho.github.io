

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using Chapel on Cray Systems &mdash; Chapel Documentation 1.23</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using Chapel on Cygwin" href="cygwin.html" />
    <link rel="prev" title="Using Chapel on Mac OS X" href="macosx.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

<a href="../index.html" class="icon icon-home"> Chapel Documentation

<!-- display version if button won't be rendered -->
<?php if (false) { ?>
<br>1.23
<?php } ?>

</a>

<?php
// Variables given by sphinx
$chplTitle = "1.23";
$pagename = "platforms/cray";
include "..//versionButton.php";
?>


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Compiling and Running Chapel</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/QUICKSTART.html">Quickstart Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/index.html">Using Chapel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Platform-Specific Notes</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#major-platforms">Major Platforms</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="macosx.html">Using Chapel on Mac OS X</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Using Chapel on Cray Systems</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#getting-started-with-chapel-on-cray-x-series-systems">Getting Started with Chapel on Cray X-Series Systems</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getting-started-with-chapel-on-cray-shasta-systems">Getting Started with Chapel on Cray Shasta Systems</a></li>
<li class="toctree-l4"><a class="reference internal" href="#getting-started-with-chapel-on-cray-cs-systems">Getting Started with Chapel on Cray CS Systems</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-chapel-for-a-cray-system-from-source">Building Chapel for a Cray System from Source</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-chapel-on-a-cray-system">Using Chapel on a Cray System</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cray-file-systems-and-chapel-execution">Cray File Systems and Chapel execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#special-notes-for-cray-xc-series-systems">Special Notes for Cray XC Series Systems</a></li>
<li class="toctree-l4"><a class="reference internal" href="#known-constraints-and-bugs">Known Constraints and Bugs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="cygwin.html">Using Chapel on Cygwin</a></li>
<li class="toctree-l3"><a class="reference internal" href="aws.html">Using Chapel on Amazon Web Services</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#networks">Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#older-platforms">Older Platforms</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../technotes/index.html">Technical Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Chapel Programs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language/reference.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Hello World Variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primers/index.html">Primers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/spec/index.html">Language Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../builtins/index.html">Built-in Types and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/standard.html">Standard Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/packages.html">Package Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/layoutdist.html">Standard Layouts and Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users-guide/index.html">Chapel Users Guide (WIP)</a></li>
</ul>
<p class="caption"><span class="caption-text">Language History</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language/evolution.html">Chapel Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/archivedSpecs.html">Documentation Archives</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Chapel Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Platform-Specific Notes</a> &raquo;</li>
        
      <li>Using Chapel on Cray Systems</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/platforms/cray.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-chapel-on-cray-systems">
<span id="readme-cray"></span><h1><a class="toc-backref" href="#id1">Using Chapel on Cray Systems</a><a class="headerlink" href="#using-chapel-on-cray-systems" title="Permalink to this headline">¶</a></h1>
<p>The following information is assembled to help Chapel users get up and running
on Cray® systems including the Cray XC™ and Shasta™
series systems.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#using-chapel-on-cray-systems" id="id1">Using Chapel on Cray Systems</a><ul>
<li><a class="reference internal" href="#getting-started-with-chapel-on-cray-x-series-systems" id="id2">Getting Started with Chapel on Cray X-Series Systems</a></li>
<li><a class="reference internal" href="#getting-started-with-chapel-on-cray-shasta-systems" id="id3">Getting Started with Chapel on Cray Shasta Systems</a></li>
<li><a class="reference internal" href="#getting-started-with-chapel-on-cray-cs-systems" id="id4">Getting Started with Chapel on Cray CS Systems</a></li>
<li><a class="reference internal" href="#building-chapel-for-a-cray-system-from-source" id="id5">Building Chapel for a Cray System from Source</a></li>
<li><a class="reference internal" href="#using-chapel-on-a-cray-system" id="id6">Using Chapel on a Cray System</a></li>
<li><a class="reference internal" href="#cray-file-systems-and-chapel-execution" id="id7">Cray File Systems and Chapel execution</a></li>
<li><a class="reference internal" href="#special-notes-for-cray-xc-series-systems" id="id8">Special Notes for Cray XC Series Systems</a><ul>
<li><a class="reference internal" href="#native-ugni-communication-layer" id="id9">Native ugni Communication Layer</a><ul>
<li><a class="reference internal" href="#using-the-ugni-communications-layer" id="id10">Using the ugni Communications Layer</a></li>
<li><a class="reference internal" href="#network-atomics" id="id11">Network Atomics</a></li>
<li><a class="reference internal" href="#ugni-communication-layer-and-the-heap" id="id12">ugni Communication Layer and the Heap</a></li>
<li><a class="reference internal" href="#ugni-communication-layer-registered-memory-regions" id="id13">ugni Communication Layer Registered Memory Regions</a></li>
<li><a class="reference internal" href="#ugni-hugepage-related-warnings" id="id14">ugni Hugepage-related Warnings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gasnet-communication-layer" id="id15">gasnet Communication Layer</a><ul>
<li><a class="reference internal" href="#gasnet-communication-layer-and-the-heap" id="id16">gasnet Communication Layer and the Heap</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#known-constraints-and-bugs" id="id17">Known Constraints and Bugs</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="getting-started-with-chapel-on-cray-x-series-systems">
<h2><a class="toc-backref" href="#id2">Getting Started with Chapel on Cray X-Series Systems</a><a class="headerlink" href="#getting-started-with-chapel-on-cray-x-series-systems" title="Permalink to this headline">¶</a></h2>
<p>Chapel is available as a module for Cray X-series systems.  When it is
installed on your system, you do not need to build Chapel from the
source release (though you can). To use Chapel with the default settings and
confirm it is correctly installed, do the following:</p>
<ol class="arabic">
<li><p class="first">Load the Chapel module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">chapel</span>
</pre></div>
</div>
</li>
<li><p class="first">Compile an example program using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>chpl $CHPL_HOME/examples/hello6-taskpar-dist.chpl
</pre></div>
</div>
</li>
<li><p class="first">Execute the resulting executable (on four locales):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">hello6</span><span class="o">-</span><span class="n">taskpar</span><span class="o">-</span><span class="n">dist</span> <span class="o">-</span><span class="n">nl</span> <span class="mi">4</span>
</pre></div>
</div>
</li>
</ol>
<p>This may be all that is necessary to use Chapel on a Cray X-Series system.
If the installation setup by your system administrator deviates from
the default settings, or you are interested in other configuration
options, see <a class="reference internal" href="#using-chapel-on-a-cray-system">Using Chapel on a Cray System</a> below.  If instead you wish to
build Chapel from source, continue on to
<a class="reference internal" href="#building-chapel-for-a-cray-system-from-source">Building Chapel for a Cray System from Source</a> just below.</p>
<p>For information on obtaining and installing the Chapel module please
contact your system administrator.</p>
</div>
<div class="section" id="getting-started-with-chapel-on-cray-shasta-systems">
<h2><a class="toc-backref" href="#id3">Getting Started with Chapel on Cray Shasta Systems</a><a class="headerlink" href="#getting-started-with-chapel-on-cray-shasta-systems" title="Permalink to this headline">¶</a></h2>
<p>Chapel is available as a module for Cray Shasta systems.  It should be
installed on your system already.  If it is not, contact your system
administrator for information on obtaining and installing the Chapel
module.</p>
<p>To use Chapel with the default settings and confirm it is correctly
installed, do the following:</p>
<ol class="arabic">
<li><p class="first">Load the Chapel module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">chapel</span>
</pre></div>
</div>
<p>Note that a side effect of loading the chapel module is that these
other modules will either be loaded or swapped to, as needed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PrgEnv</span><span class="o">-</span><span class="n">gnu</span>
<span class="n">cray</span><span class="o">-</span><span class="n">mpich</span>
<span class="n">libfabric</span>
</pre></div>
</div>
<p>And this module will be unloaded, if it is loaded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cray</span><span class="o">-</span><span class="n">libsci</span>
</pre></div>
</div>
</li>
<li><p class="first">Compile an example program like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>chpl $CHPL_HOME/examples/hello6-taskpar-dist.chpl
</pre></div>
</div>
</li>
<li><p class="first">Execute the resulting executable (on four locales):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">hello6</span><span class="o">-</span><span class="n">taskpar</span><span class="o">-</span><span class="n">dist</span> <span class="o">-</span><span class="n">nl</span> <span class="mi">4</span>
</pre></div>
</div>
</li>
</ol>
<p>Currently the number of Chapel configurations available on
Shasta systems is quite limited.  Only the following have been built
into the module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CHPL_TARGET_PLATFORM</span><span class="p">:</span> <span class="n">cray</span><span class="o">-</span><span class="n">shasta</span>
<span class="n">CHPL_TARGET_COMPILER</span><span class="p">:</span> <span class="n">cray</span><span class="o">-</span><span class="n">prgenv</span><span class="o">-</span><span class="n">gnu</span>
<span class="n">CHPL_TARGET_ARCH</span><span class="p">:</span> <span class="n">x86_64</span>
<span class="n">CHPL_TARGET_CPU</span><span class="p">:</span> <span class="n">sandybridge</span>
<span class="n">CHPL_LOCALE_MODEL</span><span class="p">:</span> <span class="n">flat</span>
<span class="n">CHPL_COMM</span><span class="p">:</span> <span class="n">none</span><span class="p">,</span> <span class="n">ofi</span>
<span class="n">CHPL_TASKS</span><span class="p">:</span> <span class="n">qthreads</span>
<span class="n">CHPL_LAUNCHER</span><span class="p">:</span> <span class="n">none</span>
<span class="n">CHPL_TIMERS</span><span class="p">:</span> <span class="n">generic</span>
<span class="n">CHPL_UNWIND</span><span class="p">:</span> <span class="n">none</span>
<span class="n">CHPL_MEM</span><span class="p">:</span> <span class="n">jemalloc</span>
<span class="n">CHPL_ATOMICS</span><span class="p">:</span> <span class="n">cstdlib</span>
  <span class="n">CHPL_NETWORK_ATOMICS</span><span class="p">:</span> <span class="n">none</span><span class="p">,</span> <span class="n">ofi</span>
<span class="n">CHPL_GMP</span><span class="p">:</span> <span class="n">none</span>
<span class="n">CHPL_HWLOC</span><span class="p">:</span> <span class="n">hwloc</span>
<span class="n">CHPL_REGEXP</span><span class="p">:</span> <span class="n">none</span>
<span class="n">CHPL_LLVM</span><span class="p">:</span> <span class="n">none</span>
<span class="n">CHPL_AUX_FILESYS</span><span class="p">:</span> <span class="n">none</span>
</pre></div>
</div>
<p>You may be able to build Chapel from source on a Shasta system if you do
not have a module already.  Generally you should be able to follow the
instructions below for building from source, but be advised that so far
only the above configurations have been built.  Also, you’ll probably
find that the module settings shown in 1) above will be required during
the build.</p>
</div>
<div class="section" id="getting-started-with-chapel-on-cray-cs-systems">
<h2><a class="toc-backref" href="#id4">Getting Started with Chapel on Cray CS Systems</a><a class="headerlink" href="#getting-started-with-chapel-on-cray-cs-systems" title="Permalink to this headline">¶</a></h2>
<p>On Cray CS systems, Chapel is not currently available as a module due
to the wide diversity of software packages that Cray CS customers may
choose to install on their system.  For this reason, Chapel must be
built from source on Cray CS systems using the
<a class="reference internal" href="#building-chapel-for-a-cray-system-from-source">Building Chapel for a Cray System from Source</a> instructions just below.</p>
</div>
<div class="section" id="building-chapel-for-a-cray-system-from-source">
<h2><a class="toc-backref" href="#id5">Building Chapel for a Cray System from Source</a><a class="headerlink" href="#building-chapel-for-a-cray-system-from-source" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">If using an XC system, continue to step 2. If using a CS series
system, set <code class="docutils literal notranslate"><span class="pre">CHPL_HOST_PLATFORM</span></code> to <code class="docutils literal notranslate"><span class="pre">cray-cs</span></code>.</p>
<p>For example:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_HOST_PLATFORM</span><span class="o">=</span>cray-cs
</pre></div>
</div>
</div></blockquote>
<p>These are the supported systems and strings.  Note that these values
are used by default when building on the given systems.  They can
also be set manually.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">System</th>
<th class="head">CHPL_HOST_PLATFORM</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CS series</td>
<td>cray-cs</td>
</tr>
<tr class="row-odd"><td>XC series</td>
<td>cray-xc</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">Optionally, set the <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER</span></code> environment variable to indicate
how Chapel should launch jobs on your system:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="62%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">On a Cray CS system, to…</th>
<th class="head">set CHPL_LAUNCHER to…</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>…run jobs interactively on your system</td>
<td>gasnetrun_ibv</td>
</tr>
<tr class="row-odd"><td>…queue jobs using SLURM (sbatch)</td>
<td>slurm-gasnetrun_ibv</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<colgroup>
<col width="62%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">On a Cray X-series system, to…</th>
<th class="head">set CHPL_LAUNCHER to…</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>…run jobs interactively on your system</td>
<td>aprun</td>
</tr>
<tr class="row-odd"><td>…queue jobs using PBS (qsub)</td>
<td>pbs-aprun</td>
</tr>
<tr class="row-even"><td>…queue jobs using SLURM (sbatch)</td>
<td>slurm-srun</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>You can also set CHPL_LAUNCHER to <code class="docutils literal notranslate"><span class="pre">none</span></code> if you prefer to manually
manage all queuing and job launch commands yourself.</p>
<p>On Cray CS systems, <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">gasnetrun_ibv</span></code>.</p>
<p>On Cray X-Series systems, <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER</span></code> defaults to <code class="docutils literal notranslate"><span class="pre">aprun</span></code> if
<code class="docutils literal notranslate"><span class="pre">aprun</span></code> is in your path, <code class="docutils literal notranslate"><span class="pre">slurm-srun</span></code> if <code class="docutils literal notranslate"><span class="pre">srun</span></code> is in your path
and <code class="docutils literal notranslate"><span class="pre">none</span></code> otherwise.</p>
<p>For more information on Chapel’s launcher capabilities and options,
refer to <a class="reference internal" href="../usingchapel/launcher.html#readme-launcher"><span class="std std-ref">Chapel Launchers</span></a>.</p>
</li>
<li><p class="first">Select the target compiler that Chapel should use when compiling
code for the compute node:</p>
<p>On a Cray CS series system, set the <code class="docutils literal notranslate"><span class="pre">CHPL_TARGET_COMPILER</span></code> environment
variable to indicate which compiler to use (and make sure that the compiler
is in your path).</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">To request…</th>
<th class="head">set CHPL_TARGET_COMPILER to…</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>…the GNU compiler (gcc)</td>
<td>gnu    (default)</td>
</tr>
<tr class="row-odd"><td>…the Intel compiler (icc)</td>
<td>intel</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>On a Cray X-series system, ensure that you have one of the following
Programming Environment modules loaded to specify your target compiler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PrgEnv</span><span class="o">-</span><span class="n">allinea</span> <span class="p">(</span><span class="n">ARM</span> <span class="n">only</span><span class="p">)</span>
<span class="n">PrgEnv</span><span class="o">-</span><span class="n">cray</span>
<span class="n">PrgEnv</span><span class="o">-</span><span class="n">gnu</span>
<span class="n">PrgEnv</span><span class="o">-</span><span class="n">intel</span>
</pre></div>
</div>
</li>
<li><p class="first">Make sure you’re in the top-level chapel/ directory and make/re-make the
compiler and runtime:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gmake</span>
</pre></div>
</div>
<p>Note that a single Chapel installation can support multiple
configurations simultaneously and that you can switch between them
simply by changing any of the above settings.  However, each
configuration must be built separately.  Thus, you can change any of
the settings in the steps before this, and then re-run this step in
order to create additional installations.  Thereafter, you can switch
between any of these configurations without rebuilding.</p>
</li>
</ol>
</div>
<div class="section" id="using-chapel-on-a-cray-system">
<h2><a class="toc-backref" href="#id6">Using Chapel on a Cray System</a><a class="headerlink" href="#using-chapel-on-a-cray-system" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">If you are working from a Chapel module:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>Load the module using <code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">chapel</span></code></li>
<li>Optionally select a launcher, as in step 2 above</li>
<li>Select a target compiler, as in step 3 above</li>
</ol>
</div></blockquote>
<p>If you are working from a source installation:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>Set your host platform as in step 1 above</li>
<li>Optionally select a launcher, as in step 2 above</li>
<li>Select a target compiler, as in step 3 above</li>
<li>Set <code class="docutils literal notranslate"><span class="pre">CHPL_HOME</span></code> and your paths by invoking the appropriate
<code class="docutils literal notranslate"><span class="pre">util/setchplenv</span></code> script for your shell.  For example:</li>
</ol>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> util/setchplenv.bash
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p class="first">Compile your Chapel program.  For example:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>chpl <span class="nv">$CHPL_HOME</span>/examples/hello6-taskpar-dist.chpl
</pre></div>
</div>
<p>See <a class="reference internal" href="../usingchapel/compiling.html#readme-compiling"><span class="std std-ref">Compiling Chapel Programs</span></a> or  <code class="docutils literal notranslate"><span class="pre">man</span> <span class="pre">chpl</span></code> for further details.</p>
</li>
<li><p class="first">If <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER</span></code> is set to anything other than <code class="docutils literal notranslate"><span class="pre">none</span></code>, when you
compile a Chapel program for your Cray system, you will see two
binaries (e.g., <code class="docutils literal notranslate"><span class="pre">hello6-taskpar-dist</span></code> and <code class="docutils literal notranslate"><span class="pre">hello6-taskpar-dist_real</span></code>).
The first binary contains code to launch the Chapel program onto
the compute nodes, as specified by your <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER</span></code> setting.  The
second contains the program code itself; it is not intended to be
executed directly from the shell prompt.</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">-v</span></code> flag to see the commands used by the launcher
binary to start your program.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER</span></code> is <code class="docutils literal notranslate"><span class="pre">pbs-aprun</span></code>:</p>
<blockquote>
<div><ol class="loweralpha">
<li><p class="first">You can optionally specify a queue name using the environment
variable <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER_QUEUE</span></code>.  For example:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_QUEUE</span><span class="o">=</span>batch
</pre></div>
</div>
</div></blockquote>
<p>If this variable is left unset, no queue name will be
specified.  Alternatively, you can set the queue name on your
Chapel program command line using the <code class="docutils literal notranslate"><span class="pre">--queue</span></code> flag.</p>
</li>
<li><p class="first">You can also optionally set a wall clock time limit for the
job using <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER_WALLTIME</span></code>.  For example to specify a
10-minute time limit, use:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_WALLTIME</span><span class="o">=</span><span class="m">00</span>:10:00
</pre></div>
</div>
</div></blockquote>
<p>Alternatively, you can set the wall clock time limit on your
Chapel program command line using the <code class="docutils literal notranslate"><span class="pre">--walltime</span></code> flag.</p>
</li>
</ol>
</div></blockquote>
<p>For further information about launchers, please refer to
<a class="reference internal" href="../usingchapel/launcher.html#readme-launcher"><span class="std std-ref">Chapel Launchers</span></a>.</p>
</li>
<li><p class="first">Execute your Chapel program.  Multi-locale executions require the
number of locales (compute nodes) to be specified on the command
line.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">hello6</span><span class="o">-</span><span class="n">taskpar</span><span class="o">-</span><span class="n">dist</span> <span class="o">-</span><span class="n">nl</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Requests the program to be executed using two locales.</p>
</li>
<li><p class="first">If your Cray system has compute nodes with varying numbers of
cores, you can request nodes with at least a certain number of
cores using the variable <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER_CORES_PER_LOCALE</span></code>.  For
example, on a Cray system in which some compute nodes have 24 or
more cores per compute node, you could request nodes with at least
24 cores using:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_CORES_PER_LOCALE</span><span class="o">=</span><span class="m">24</span>
</pre></div>
</div>
<p>This variable may be needed when you are using the aprun launcher and
running Chapel programs within batch jobs you are managing yourself.
The aprun launcher currently creates aprun commands that request the
maximum number of cores per locale found on any locale in the system,
irrespective of the fact that the batch job may have a lower limit
than that on the number of cores per locale.  If the batch job limit
is less than the maximum number of cores per locale, you will get the
following error message when you try to run a Chapel program:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apsched</span><span class="p">:</span> <span class="n">claim</span> <span class="n">exceeds</span> <span class="n">reservation</span><span class="s1">&#39;s CPUs</span>
</pre></div>
</div>
<p>You can work around this by setting <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER_CORES_PER_LOCALE</span></code> to
the same or lesser value as the number of cores per locale specified
for the batch job (for example, the mppdepth resource for the PBS
qsub command).  In the future we hope to achieve better integration
between Chapel launchers and workload managers.</p>
</li>
<li><p class="first">If your Cray system has compute nodes with varying numbers of CPUs
per compute unit, you can request nodes with a certain number of
CPUs per compute unit using the variable <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER_CPUS_PER_CU</span></code>.
For example, on a Cray XC series system with some nodes having at
least 2 CPUs per compute unit, to request running on those nodes
you would use:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_CPUS_PER_CU</span><span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
<p>Currently, the only legal values for <code class="docutils literal notranslate"><span class="pre">CHPL_LAUNCHER_CPUS_PER_CU</span></code> are
0 (the default), 1, and 2.</p>
</li>
</ol>
<table border="1" class="docutils">
<colgroup>
<col width="58%" />
<col width="42%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">For more information on…</th>
<th class="head">see…</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>…CHPL_* environment settings</td>
<td><a class="reference internal" href="../usingchapel/chplenv.html#readme-chplenv"><span class="std std-ref">Setting up Your Environment for Chapel</span></a></td>
</tr>
<tr class="row-odd"><td>…Compiling Chapel programs</td>
<td><a class="reference internal" href="../usingchapel/compiling.html#readme-compiling"><span class="std std-ref">Compiling Chapel Programs</span></a></td>
</tr>
<tr class="row-even"><td>…Launcher options</td>
<td><a class="reference internal" href="../usingchapel/launcher.html#readme-launcher"><span class="std std-ref">Chapel Launchers</span></a></td>
</tr>
<tr class="row-odd"><td>…Executing Chapel programs</td>
<td><a class="reference internal" href="../usingchapel/executing.html#readme-executing"><span class="std std-ref">Executing Chapel Programs</span></a></td>
</tr>
<tr class="row-even"><td>…Running multi-locale Chapel programs</td>
<td><a class="reference internal" href="../usingchapel/multilocale.html#readme-multilocale"><span class="std std-ref">Multilocale Chapel Execution</span></a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cray-file-systems-and-chapel-execution">
<h2><a class="toc-backref" href="#id7">Cray File Systems and Chapel execution</a><a class="headerlink" href="#cray-file-systems-and-chapel-execution" title="Permalink to this headline">¶</a></h2>
<p>For best results, it is recommended that you execute your Chapel
program by placing the binaries on a file system shared between the
login node and compute nodes (typically Lustre), as this will provide
the greatest degree of transparency when executing your program.  In
some cases, running a Chapel program from a non-shared file system
will make it impossible to launch onto the compute nodes.  In other
cases, the launch will succeed, but any files read or written by the
Chapel program will be opened relative to the compute node’s file
system rather than the login node’s.</p>
</div>
<div class="section" id="special-notes-for-cray-xc-series-systems">
<h2><a class="toc-backref" href="#id8">Special Notes for Cray XC Series Systems</a><a class="headerlink" href="#special-notes-for-cray-xc-series-systems" title="Permalink to this headline">¶</a></h2>
<div class="section" id="native-ugni-communication-layer">
<span id="ugni-comm-on-cray"></span><h3><a class="toc-backref" href="#id9">Native ugni Communication Layer</a><a class="headerlink" href="#native-ugni-communication-layer" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../usingchapel/multilocale.html#readme-multilocale"><span class="std std-ref">Multilocale Chapel Execution</span></a> page describes the runtime communication
layer implementations that can be used by Chapel programs.  In addition
to the standard ones, Chapel supports a Cray-specific <code class="docutils literal notranslate"><span class="pre">ugni</span></code>
communication layer.  The ugni communication layer interacts with
the system’s network interface very closely through a lightweight
interface called uGNI (user Generic Network Interface).  On Cray XC
systems the ugni communication layer is the default.</p>
<div class="section" id="using-the-ugni-communications-layer">
<h4><a class="toc-backref" href="#id10">Using the ugni Communications Layer</a><a class="headerlink" href="#using-the-ugni-communications-layer" title="Permalink to this headline">¶</a></h4>
<p>To use ugni communications:</p>
<ol class="arabic">
<li><p class="first">Leave your <code class="docutils literal notranslate"><span class="pre">CHPL_COMM</span></code> environment variable unset or set it to
<code class="docutils literal notranslate"><span class="pre">ugni</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>ugni
</pre></div>
</div>
<p>This specifies that you wish to use the Cray-specific communication
layer.</p>
</li>
<li><p class="first"><em>(Optional)</em> Load an appropriate <code class="docutils literal notranslate"><span class="pre">craype-hugepages</span></code> module.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">load</span> <span class="n">craype</span><span class="o">-</span><span class="n">hugepages16M</span>
</pre></div>
</div>
<p>The ugni communication layer can be used with or without so-called
<em>hugepages</em>.  Performance for remote variable references is much
better when hugepages are used.  The only downside of using hugepages
is that the tasking layer may not be able to detect task stack
overflows by means of guard pages (see below).</p>
<p>To use hugepages, you must have a <code class="docutils literal notranslate"><span class="pre">craype-hugepages</span></code> module loaded
both when building your program and when running it.  There are
several hugepage modules, with suffixes indicating the page size they
support.  For example, <code class="docutils literal notranslate"><span class="pre">craype-hugepages16M</span></code> supports 16 MiB
hugepages.  It does not matter which <code class="docutils literal notranslate"><span class="pre">craype-hugepages</span></code> module you
have loaded when you build your program.  Any of them will do.  Which
one you have loaded when you run a program does matter, however.  For
general use, the Chapel group recommends the <code class="docutils literal notranslate"><span class="pre">craype-hugepages16M</span></code>
module.  You can read on for more information about hugepage modules
if you would like, but the recommended <code class="docutils literal notranslate"><span class="pre">craype-hugepages16M</span></code> module
will probably give you satisfactory results.</p>
<p>The Cray network interface chips (NICs) can only address memory that
has been registered with them. In practical terms, the Aries(TM) NIC
on Cray XC systems is not limited as to how much memory it can
register.  However, it does have an on-board cache of 512 registered
page table entries, and registering more than this can cause reduced
performance if the program’s memory reference pattern causes refills
in this cache.  We have seen up to a 15% reduction from typical
nightly XC-16 performance in an ra-rmo run using hugepages small
enough that every reference should have missed in this cache.
Covering an entire 128 GiB XC compute node with only 512 hugepages
will require at least the <code class="docutils literal notranslate"><span class="pre">craype-hugepages256M</span></code> module’s 256 MiB
hugepages.</p>
<p>Offsetting this, using larger hugepages may reduce performance because
it can result in poorer NUMA affinity.  With the ugni communication
layer, arrays larger than 2 hugepages are allocated separately from the
heap, which improves NUMA affinity.  An obvious side effect of using
larger hugepages is that an array has to be larger to qualify.  Thus,
achieving the best performance for any given program may require
striking a balance between using larger hugepages to reduce NIC page
table cache refills and using smaller ones to improve NUMA locality.</p>
<p>Note that when hugepages are used with the ugni comm layer, tasking
layers cannot use guard pages for stack overflow detection.  Qthreads
tasking cannot detect stack overflow except by means of guard pages,
so if ugni communications is combined with qthreads tasking and a
hugepage module is loaded, stack overflow detection is unavailable.</p>
</li>
</ol>
</div>
<div class="section" id="network-atomics">
<h4><a class="toc-backref" href="#id11">Network Atomics</a><a class="headerlink" href="#network-atomics" title="Permalink to this headline">¶</a></h4>
<p>The Aries networks on Cray XC series systems support remote atomic
memory operations (AMOs).  When the <code class="docutils literal notranslate"><span class="pre">CHPL_NETWORK_ATOMICS</span></code> environment
variable is set to <code class="docutils literal notranslate"><span class="pre">ugni</span></code>, the following operations on remote atomics
are done using the network:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">32</span><span class="o">-</span> <span class="ow">and</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">signed</span> <span class="ow">and</span> <span class="n">unsigned</span> <span class="n">integer</span> <span class="n">types</span><span class="p">:</span>
<span class="mi">32</span><span class="o">-</span> <span class="ow">and</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">real</span> <span class="n">types</span><span class="p">:</span>
  <span class="n">read</span><span class="p">()</span>
  <span class="n">write</span><span class="p">()</span>
  <span class="n">exchange</span><span class="p">()</span>
  <span class="n">compareAndSwap</span><span class="p">()</span>
  <span class="n">add</span><span class="p">(),</span> <span class="n">fetchAdd</span><span class="p">()</span>
  <span class="n">sub</span><span class="p">(),</span> <span class="n">fetchSub</span><span class="p">()</span>

<span class="mi">32</span><span class="o">-</span> <span class="ow">and</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">signed</span> <span class="ow">and</span> <span class="n">unsigned</span> <span class="n">integer</span> <span class="n">types</span><span class="p">:</span>
  <span class="ow">or</span><span class="p">(),</span>  <span class="n">fetchOr</span><span class="p">()</span>
  <span class="ow">and</span><span class="p">(),</span> <span class="n">fetchAnd</span><span class="p">()</span>
  <span class="n">xor</span><span class="p">(),</span> <span class="n">fetchXor</span><span class="p">()</span>
</pre></div>
</div>
<p>All of the operations shown above are done natively by the network
hardware except 64-bit real add, which is disabled in hardware and thus
done using <code class="docutils literal notranslate"><span class="pre">on</span></code> statements.</p>
</div>
<div class="section" id="ugni-communication-layer-and-the-heap">
<h4><a class="toc-backref" href="#id12">ugni Communication Layer and the Heap</a><a class="headerlink" href="#ugni-communication-layer-and-the-heap" title="Permalink to this headline">¶</a></h4>
<p>The “heap” is an area of memory used for dynamic allocation of
everything from user data to internal management data structures.
When running on Cray XC systems using the default configuration
with the ugni comm layer and a <code class="docutils literal notranslate"><span class="pre">craype-hugepages</span></code> module loaded, the
heap is used for all dynamic allocations except data space for arrays
larger than 2 hugepages.  (See <a class="reference internal" href="#using-the-ugni-communications-layer">Using the ugni Communications Layer</a>,
just above, for more about hugepages.)  It is normally extended
dynamically, as needed.  But if desired, the heap can instead be created
at a specified fixed size at the beginning of execution.  In some cases
this will reduce certain internal comm layer overheads and marginally
improve performance.</p>
<p>The disadvantage of a fixed heap is that it usually produces worse NUMA
affinity, it limits available heap memory to the specified fixed size,
and it limits memory for arrays to whatever remains after the fixed-size
heap is created.  If either of the latter are less than what a program
needs, it will terminate prematurely with an “Out of memory” message.</p>
<p>To specify a fixed heap, set the <code class="docutils literal notranslate"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> environment
variable to indicate its size.  For the value of this variable you can
use any of the following formats, where <em>num</em> is a positive integer
number:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="86%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Format</th>
<th class="head">Resulting Heap Size</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>num</td>
<td>num bytes</td>
</tr>
<tr class="row-odd"><td>num[kK]</td>
<td>num * 2**10 bytes</td>
</tr>
<tr class="row-even"><td>num[mM]</td>
<td>num * 2**20 bytes</td>
</tr>
<tr class="row-odd"><td>num[gG]</td>
<td>num * 2**30 bytes</td>
</tr>
<tr class="row-even"><td>num%</td>
<td>percentage of compute node physical memory</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Any of the following would specify an approximately 1 GiB heap on a
128-GiB compute node, for example:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span><span class="m">1073741824</span>
<span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span>1048576k
<span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span>1024m
<span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span>1g
<span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span><span class="m">1</span>% <span class="c1"># 1.28 GiB, really</span>
</pre></div>
</div>
</div></blockquote>
<p>Note that the resulting heap size may get rounded up to match the page
alignment.  How much this will add, if any, depends on the hugepage size
in any <code class="docutils literal notranslate"><span class="pre">craype-hugepage</span></code> module you have loaded at the time you
execute the program.  It may also be reduced, if some resource
limitation prevents making the heap as large as requested.</p>
</div>
<div class="section" id="ugni-communication-layer-registered-memory-regions">
<h4><a class="toc-backref" href="#id13">ugni Communication Layer Registered Memory Regions</a><a class="headerlink" href="#ugni-communication-layer-registered-memory-regions" title="Permalink to this headline">¶</a></h4>
<p>The ugni communication layer maintains information about every memory
region it registers with Aries NIC.  Roughly speaking there are a few
memory regions for each tasking layer thread, plus one for each array
larger than 2 hugepages allocated and registered separately from the
heap.  By default the comm layer can handle up to 16k (2**14) total
memory regions, which is plenty under normal circumstances.  In the
event a program needs more than this, a message like the following will
be printed:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>warning: no more registered memory region table entries <span class="o">(</span>max is <span class="m">16384</span><span class="o">)</span>.
         Change using CHPL_RT_COMM_UGNI_MAX_MEM_REGIONS.
</pre></div>
</div>
</div></blockquote>
<p>To provide for more registered regions, set the
<code class="docutils literal notranslate"><span class="pre">CHPL_RT_COMM_UGNI_MAX_MEM_REGIONS</span></code> environment variable to a number
indicating how many you want to allow.  For example:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_RT_COMM_UGNI_MAX_MEM_REGIONS</span><span class="o">=</span><span class="m">30000</span>
</pre></div>
</div>
</div></blockquote>
<p>Note that there are certain comm layer overheads that are proportional to
the number of registered memory regions, so allowing a very high number of
them may lead to reduced performance.</p>
</div>
<div class="section" id="ugni-hugepage-related-warnings">
<h4><a class="toc-backref" href="#id14">ugni Hugepage-related Warnings</a><a class="headerlink" href="#ugni-hugepage-related-warnings" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>Communication performance with ugni is so much better when hugepages
are used that if you do not use them, the runtime will print the
following warning when a multilocale program starts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">warning</span><span class="p">:</span> <span class="n">without</span> <span class="n">hugepages</span><span class="p">,</span> <span class="n">communication</span> <span class="n">performance</span> <span class="n">will</span> <span class="n">suffer</span>
</pre></div>
</div>
<p>If you definitely do not want to use hugepages you can quiet this
warning by giving the <code class="docutils literal notranslate"><span class="pre">--quiet</span></code> or <code class="docutils literal notranslate"><span class="pre">-q</span></code> option when you run the
executable.  Otherwise, load a hugepage module as described above in
<a class="reference internal" href="#using-the-ugni-communications-layer">Using the ugni Communications Layer</a> before running.</p>
<p>When you are using hugepages and do not have a fixed heap (that is,
the <code class="docutils literal notranslate"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> environment variable is not set), the
Chapel runtime expects certain hugepage-related environment variables
to have been set by the Chapel launcher.  If you do not use a Chapel
launcher you have to provide these settings yourself.  Not doing so
will result in one or both of the following messages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">warning</span><span class="p">:</span> <span class="n">dynamic</span> <span class="n">heap</span> <span class="n">on</span> <span class="n">hugepages</span> <span class="n">needs</span> <span class="n">HUGETLB_NO_RESERVE</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">something</span>
<span class="n">warning</span><span class="p">:</span> <span class="n">dynamic</span> <span class="n">heap</span> <span class="n">on</span> <span class="n">hugepages</span> <span class="n">needs</span> <span class="n">CHPL_JE_MALLOC_CONF</span> <span class="nb">set</span> <span class="n">properly</span>
</pre></div>
</div>
<p>To quiet these warnings, use the following settings:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">HUGETLB_NO_RESERVE</span><span class="o">=</span>yes
<span class="nb">export</span> <span class="nv">CHPL_JE_MALLOC_CONF</span><span class="o">=</span>purge:decay,lg_chunk:log2HPS
</pre></div>
</div>
</div></blockquote>
<p>where <em>log2HPS</em> is the base-2 log of the hugepage size.  For example,
with 16 MiB hugepages you would use:</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_JE_MALLOC_CONF</span><span class="o">=</span>purge:decay,lg_chunk:24
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</div>
</div>
<div class="section" id="gasnet-communication-layer">
<h3><a class="toc-backref" href="#id15">gasnet Communication Layer</a><a class="headerlink" href="#gasnet-communication-layer" title="Permalink to this headline">¶</a></h3>
<p>The GASNet-based communication layer discussed in the
<a class="reference internal" href="../usingchapel/multilocale.html#readme-multilocale"><span class="std std-ref">Multilocale Chapel Execution</span></a> page can be used on all Cray systems.  For
best performance it should be used with native substrates and fixed
segments, though even then its performance will rarely match that of the
ugni communication layer.  The relevant configurations are:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CHPL_COMM</span><span class="o">=</span><span class="n">gasnet</span>
  <span class="n">CHPL_COMM_SUBSTRATE</span><span class="o">=</span><span class="n">aries</span> <span class="p">(</span><span class="k">for</span> <span class="n">XC</span><span class="p">)</span>
  <span class="n">CHPL_GASNET_SEGMENT</span><span class="o">=</span><span class="n">fast</span> <span class="ow">or</span> <span class="n">large</span>
</pre></div>
</div>
<p>In these configurations the heap is created with a fixed size at the
beginning of execution.  The default size works well in most cases but
if it doesn’t a different size can be specified, as discussed in the
following section.</p>
<div class="section" id="gasnet-communication-layer-and-the-heap">
<h4><a class="toc-backref" href="#id16">gasnet Communication Layer and the Heap</a><a class="headerlink" href="#gasnet-communication-layer-and-the-heap" title="Permalink to this headline">¶</a></h4>
<p>In contrast to the dynamic heap extension available in the ugni comm
layer, when the gasnet comm layer is used with a native substrate for
higher network performance, the runtime must know up front the maximum
size the heap will grow to during execution.</p>
<p>In these cases the heap is used for all dynamic allocations, including
arrays.  By default it will occupy as much of the free memory on each
compute node as the runtime can acquire, less some small amount to allow
for demands from other (system) programs running there.  Advanced users
may want to make the heap smaller than the default.  Programs start more
quickly with a smaller heap, and in the unfortunate event that you need
to produce core files, those will be written more quickly if the heap is
smaller.  Specify the heap size using the <code class="docutils literal notranslate"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code>
environment variable, as discussed above in <a class="reference internal" href="#ugni-communication-layer-and-the-heap">ugni Communication Layer
and the Heap</a>.  But be aware that just as in the <code class="docutils literal notranslate"><span class="pre">CHPL_COMM=ugni</span></code>
case, if you reduce the heap size to less than the amount your program
actually needs and then run it, it will terminate prematurely due to not
having enough memory.</p>
<p>Note that for <code class="docutils literal notranslate"><span class="pre">CHPL_COMM=gasnet</span></code>, <code class="docutils literal notranslate"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> is
synonymous with <code class="docutils literal notranslate"><span class="pre">GASNET_MAX_SEGSIZE</span></code>, and the former overrides the
latter if both are set.</p>
</div>
</div>
</div>
<div class="section" id="known-constraints-and-bugs">
<span id="readme-cray-constraints"></span><h2><a class="toc-backref" href="#id17">Known Constraints and Bugs</a><a class="headerlink" href="#known-constraints-and-bugs" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Our PBS launcher explicitly supports PBS Pro, Moab/Torque, and the
NCCS site versions of PBS.  It may also work with other versions.
If our PBS launcher does not work for you, you can fall back on a
more manual launch of your program. For example, supposing the
program is compiled to <code class="docutils literal notranslate"><span class="pre">myprogram</span></code>:</p>
<ul class="simple">
<li>Launch the <code class="docutils literal notranslate"><span class="pre">myprogram_real</span></code> binary manually using aprun and your own
qsub script or command.</li>
<li>Use <code class="docutils literal notranslate"><span class="pre">./myprogram</span> <span class="pre">--generate-qsub-script</span></code> to generate a qsub script.
Then edit the generated script and launch the <code class="docutils literal notranslate"><span class="pre">myprogram_real</span></code> binary
manually as above.</li>
</ul>
</li>
<li><p class="first">Redirecting stdin when executing a Chapel program under PBS/qsub
may not work due to limitations of qsub.</p>
</li>
<li><p class="first">For X-series systems, there is a known issue with the Cray MPI
release that causes some programs to assert and then hang during
exit.  A workaround is to set the environment variable,
<code class="docutils literal notranslate"><span class="pre">MPICH_GNI_DYNAMIC_CONN</span></code> to <code class="docutils literal notranslate"><span class="pre">disabled</span></code>.  Setting this environment
variable affects all MPI programs, so remember to unset it after
running your Chapel program.</p>
</li>
<li><p class="first">The amount of memory available to a Chapel program running over
GASNet with the aries conduit is allocated at program start up.  The
default memory segment size may be too high on some platforms,
resulting in an internal Chapel error or a GASNet initialization
error such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>node 1 log gasnetc_init_segment() at $CHPL_HOME/third-party/gasnet/gasnet-src/aries-conduit/gasnet_aries.c:&lt;line#&gt;: MemRegister segment fault 8 at  0x2aab6ae00000 60000000, code GNI_RC_ERROR_RESOURCE
</pre></div>
</div>
<p>If your Chapel program exits with such an error, try setting the
environment variable <code class="docutils literal notranslate"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> or <code class="docutils literal notranslate"><span class="pre">GASNET_MAX_SEGSIZE</span></code> to a
lower value than the default (say 1G) and re-running your program.
For more information, refer to the discussion of <code class="docutils literal notranslate"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code>
above and/or the discussion of <code class="docutils literal notranslate"><span class="pre">GASNET_MAX_SEGSIZE</span></code> here:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$CHPL_HOME/third-party/gasnet/gasnet-src/README
</pre></div>
</div>
</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cygwin.html" class="btn btn-neutral float-right" title="Using Chapel on Cygwin" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="macosx.html" class="btn btn-neutral float-left" title="Using Chapel on Mac OS X" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Hewlett Packard Enterprise Development LP

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 



</body>
</html>