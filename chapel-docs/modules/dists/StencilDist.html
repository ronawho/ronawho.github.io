

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>StencilDist &mdash; Chapel Documentation 1.23</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="BlockCycDim" href="dims/BlockCycDim.html" />
    <link rel="prev" title="ReplicatedDist" href="ReplicatedDist.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

<a href="../../index.html" class="icon icon-home"> Chapel Documentation

<!-- display version if button won't be rendered -->
<?php if (false) { ?>
<br>1.23
<?php } ?>

</a>

<?php
// Variables given by sphinx
$chplTitle = "1.23";
$pagename = "modules/dists/StencilDist";
include "../..//versionButton.php";
?>


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Compiling and Running Chapel</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usingchapel/QUICKSTART.html">Quickstart Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usingchapel/index.html">Using Chapel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../platforms/index.html">Platform-Specific Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../technotes/index.html">Technical Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Chapel Programs</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../language/reference.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Hello World Variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../primers/index.html">Primers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../language/spec/index.html">Language Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../builtins/index.html">Built-in Types and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../standard.html">Standard Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../packages.html">Package Modules</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../layoutdist.html">Standard Layouts and Distributions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../layoutdist.html#standard-layouts">Standard Layouts</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../layoutdist.html#standard-distributions">Standard Distributions</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="BlockCycDist.html">BlockCycDist</a></li>
<li class="toctree-l3"><a class="reference internal" href="BlockDist.html">BlockDist</a></li>
<li class="toctree-l3"><a class="reference internal" href="CyclicDist.html">CyclicDist</a></li>
<li class="toctree-l3"><a class="reference internal" href="DimensionalDist2D.html">DimensionalDist2D</a></li>
<li class="toctree-l3"><a class="reference internal" href="HashedDist.html">HashedDist</a></li>
<li class="toctree-l3"><a class="reference internal" href="PrivateDist.html">PrivateDist</a></li>
<li class="toctree-l3"><a class="reference internal" href="ReplicatedDist.html">ReplicatedDist</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">StencilDist</a></li>
<li class="toctree-l3"><a class="reference internal" href="dims/BlockCycDim.html">BlockCycDim</a></li>
<li class="toctree-l3"><a class="reference internal" href="dims/BlockDim.html">BlockDim</a></li>
<li class="toctree-l3"><a class="reference internal" href="dims/ReplicatedDim.html">ReplicatedDim</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../layoutdist.html#index">Index</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../users-guide/index.html">Chapel Users Guide (WIP)</a></li>
</ul>
<p class="caption"><span class="caption-text">Language History</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../language/evolution.html">Chapel Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../language/archivedSpecs.html">Documentation Archives</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Chapel Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../layoutdist.html">Standard Layouts and Distributions</a> &raquo;</li>
        
      <li>StencilDist</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/modules/dists/StencilDist.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <span class="target" id="module-StencilDist"></span><div class="section" id="stencildist">
<h1>StencilDist<a class="headerlink" href="#stencildist" title="Permalink to this headline">¶</a></h1>
<p><strong>Usage</strong></p>
<div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">StencilDist</span><span class="p">;</span>
</pre></div>
</div>
<dl class="class">
<dt id="StencilDist.Stencil">
<em class="property">class </em><code class="descname">Stencil</code><a class="headerlink" href="#StencilDist.Stencil" title="Permalink to this definition">¶</a></dt>
<dd><p>The Stencil distribution is a variant of the <a class="reference internal" href="BlockDist.html#module-BlockDist" title="BlockDist"><code class="xref chpl chpl-mod docutils literal notranslate"><span class="pre">Block</span></code></a>
distribution that attempts to improve performance for stencil computations by
reducing the amount of communication necessary during array accesses. From
the user’s perspective, it behaves very similarly to the Block distribution
where reads, writes, and iteration are concerned.</p>
<p>This distribution reduces communication by creating read-only caches for
elements adjacent to the block of elements owned by each locale. This
documentation may refer to these cached regions as ‘ghost cells’ or ‘fluff’.
This approach can avoid many fine-grained GETs and PUTs when performing a
stencil computation near the boundary of the current locale’s chunk of array
elements. The user must manually refresh these caches after writes by calling
the <code class="docutils literal notranslate"><span class="pre">updateFluff</span></code> method. Otherwise, reading and writing array elements
behaves the same as a Block-distributed array.</p>
<p>The indices are partitioned in the same way as the <a class="reference internal" href="BlockDist.html#module-BlockDist" title="BlockDist"><code class="xref chpl chpl-mod docutils literal notranslate"><span class="pre">Block</span></code></a>
distribution.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Stencil</span></code> class initializer is defined as follows:</p>
<blockquote>
<div><div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="k">proc</span> <span class="nf">Stencil.init</span><span class="p">(</span>
  <span class="nx">boundingBox</span><span class="p">:</span> <span class="k">domain</span><span class="p">,</span>
  <span class="nx">targetLocales</span><span class="p">:</span> <span class="p">[]</span> <span class="nx">locale</span>  <span class="o">=</span> <span class="nx">Locales</span><span class="p">,</span>
  <span class="nx">dataParTasksPerLocale</span>     <span class="o">=</span> <span class="c1">// value of  dataParTasksPerLocale      config const,</span>
  <span class="nx">dataParIgnoreRunningTasks</span> <span class="o">=</span> <span class="c1">// value of  dataParIgnoreRunningTasks  config const,</span>
  <span class="nx">dataParMinGranularity</span>     <span class="o">=</span> <span class="c1">// value of  dataParMinGranularity      config const,</span>
  <span class="kd">param</span> <span class="nx">rank</span>                <span class="o">=</span> <span class="nx">boundingBox</span><span class="p">.</span><span class="nx">rank</span><span class="p">,</span>
  <span class="kd">type</span>  <span class="nx">idxType</span>             <span class="o">=</span> <span class="nx">boundingBox</span><span class="p">.</span><span class="nx">idxType</span><span class="p">,</span>
  <span class="nx">fluff</span><span class="p">:</span> <span class="nx">rank</span><span class="o">*</span><span class="nx">idxType</span>       <span class="o">=</span> <span class="nx">makeZero</span><span class="p">(</span><span class="nx">rank</span><span class="p">),</span>
  <span class="nx">periodic</span><span class="p">:</span> <span class="kt">bool</span>            <span class="o">=</span> <span class="kc">false</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">fluff</span></code> argument indicates the requested number of cached elements in
each dimension. If an element of <code class="docutils literal notranslate"><span class="pre">fluff</span></code> is greater than zero, the user can
use indices outside of <code class="docutils literal notranslate"><span class="pre">boundingBox</span></code> to index into the array. If the domain
is not strided, you can consider indices for dimension <code class="docutils literal notranslate"><span class="pre">i</span></code> to be:</p>
<div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="nx">boundingBox</span><span class="p">.</span><span class="nx">dim</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">expand</span><span class="p">(</span><span class="nx">fluff</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>
</pre></div>
</div>
<p>If the domain is strided:</p>
<div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="kd">const</span> <span class="nx">bb</span> <span class="o">=</span> <span class="nx">boundingBox</span><span class="p">.</span><span class="nx">dim</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="nx">bb</span><span class="p">.</span><span class="nx">expand</span><span class="p">(</span><span class="nx">fluff</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="nx">abs</span><span class="p">(</span><span class="nx">bb</span><span class="p">.</span><span class="nx">stride</span><span class="p">));</span>
</pre></div>
</div>
<p>The same logic is used when determining the cached index set on each locale,
except you can imagine <code class="docutils literal notranslate"><span class="pre">boundingBox</span></code> to be replaced with the returned
value from <a class="reference internal" href="../../builtins/ChapelArray.html#ChapelArray.localSubdomain" title="ChapelArray.localSubdomain"><code class="xref chpl chpl-proc docutils literal notranslate"><span class="pre">localSubdomain</span></code></a>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">periodic</span></code> argument indicates whether or not the stencil distribution
should treat the array as a discrete chunk in a larger space. When enabled,
the ghost cells outside of <code class="docutils literal notranslate"><span class="pre">boundingBox</span></code> will contain values as if the
array was replicated on all sides of the space. When disabled, the outermost
ghost cells will be initialized with the default value of the element’s type.
The <code class="docutils literal notranslate"><span class="pre">periodic</span></code> functionality is disabled by default.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Note that this domain does not currently handle indices outside of
the expanded bounding box, so a user must manually wrap periodic indices
themselves.</p>
</div>
<p>Iterating directly over a Stencil-distributed domain or array will only yield
indices and elements within the <code class="docutils literal notranslate"><span class="pre">boundingBox</span></code>.</p>
<p><strong>Updating the Cached Elements</strong></p>
<p>Once you have completed a series of writes to the array, you will need to
call the <code class="docutils literal notranslate"><span class="pre">updateFluff</span></code> function to update the cached elements for each
locale. Here is a simple example:</p>
<div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">StencilDist</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">Dom</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span><span class="p">};</span>
<span class="kd">const</span> <span class="nx">Space</span> <span class="o">=</span> <span class="nx">Dom</span> <span class="k">dmapped</span> <span class="nx">Stencil</span><span class="p">(</span><span class="nx">Dom</span><span class="p">,</span> <span class="nx">fluff</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">A</span> <span class="p">:</span> <span class="p">[</span><span class="nx">Space</span><span class="p">]</span> <span class="kt">int</span><span class="p">;</span>

<span class="p">[(</span><span class="nx">i</span><span class="p">,</span><span class="nx">j</span><span class="p">)</span> <span class="kd">in</span> <span class="nx">Space</span><span class="p">]</span> <span class="nx">A</span><span class="p">[</span><span class="nx">i</span><span class="p">,</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="nx">j</span><span class="p">;</span>

<span class="c1">// At this point, the ghost cell caches are out of date</span>

<span class="nx">A</span><span class="p">.</span><span class="nx">updateFluff</span><span class="p">();</span>

<span class="c1">// ghost caches are now up-to-date</span>
</pre></div>
</div>
<p>After updating, any read from the array should be up-to-date. The
<code class="docutils literal notranslate"><span class="pre">updateFluff</span></code> function does not currently accept any arguments.</p>
<p><strong>Reading and Writing to Array Elements</strong></p>
<p>The Stencil distribution uses ghost cells as cached read-only values from
other locales. When reading from a Stencil-distributed array, the
distribution will attempt to read from the local ghost cache first. If the
index is not within the cached index set of the current locale, then we
default to a remote read from the locale on which the element is located.</p>
<p>Any write to array data will be applied to the actual element, the same as if
you were using a Block-distributed array.</p>
<p><strong>Modifying Exterior Ghost Cells</strong></p>
<p>Updating the outermost ghost cells can be useful when working with a periodic
stencil-distributed array. If your array contains position information, you may
want to modify the ghost cells to ‘wrap’ around the physical space correctly.</p>
<p>You can currently do this with the <code class="docutils literal notranslate"><span class="pre">boundaries()</span></code> iterator on a
stencil-distributed array. This iterator yields a tuple where the first component
is the ghost cell element to be modified, and the second component is a tuple
indicating the side on which this ghost cell lives. This direction tuple will
contain values in the range <code class="docutils literal notranslate"><span class="pre">-1..1</span></code>.</p>
<p>The release benchmark ‘miniMD’ contains an example of how one might use this
iterator.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There is a known issue with this iterator where the program will fail to
compile if the array element is not an array or a class.</p>
</div>
</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="dims/BlockCycDim.html" class="btn btn-neutral float-right" title="BlockCycDim" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ReplicatedDist.html" class="btn btn-neutral float-left" title="ReplicatedDist" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Hewlett Packard Enterprise Development LP

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 



</body>
</html>